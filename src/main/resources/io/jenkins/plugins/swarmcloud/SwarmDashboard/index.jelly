<?jelly escape='true'?>
<j:jelly xmlns:j="jelly:core" xmlns:st="jelly:stapler" xmlns:l="/lib/layout"
         xmlns:f="/lib/form" xmlns:t="/lib/hudson">
    <l:layout title="Swarm Agents Dashboard" norefresh="true">
        <l:main-panel>
            <style>
                /* shadcn/ui inspired styles with dark theme support */
                :root {
                    --radius: 0.5rem;
                    --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
                    --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);

                    /* Light theme colors */
                    --swarm-bg: #ffffff;
                    --swarm-card-bg: #ffffff;
                    --swarm-border: hsl(214 32% 91%);
                    --swarm-input-bg: hsl(210 40% 98%);
                    --swarm-text: hsl(222 47% 11%);
                    --swarm-text-secondary: hsl(215 16% 47%);
                    --swarm-hover-bg: hsl(210 40% 98%);
                }

                /* Dark theme colors */
                @media (prefers-color-scheme: dark) {
                    :root {
                        --swarm-bg: hsl(222 47% 11%);
                        --swarm-card-bg: hsl(217 33% 17%);
                        --swarm-border: hsl(217 33% 25%);
                        --swarm-input-bg: hsl(217 33% 20%);
                        --swarm-text: hsl(210 40% 98%);
                        --swarm-text-secondary: hsl(215 20% 65%);
                        --swarm-hover-bg: hsl(217 33% 22%);
                    }
                }

                /* Jenkins dark theme detection */
                [data-theme="dark"] {
                    --swarm-bg: hsl(222 47% 11%);
                    --swarm-card-bg: hsl(217 33% 17%);
                    --swarm-border: hsl(217 33% 25%);
                    --swarm-input-bg: hsl(217 33% 20%);
                    --swarm-text: hsl(210 40% 98%);
                    --swarm-text-secondary: hsl(215 20% 65%);
                    --swarm-hover-bg: hsl(217 33% 22%);
                }

                .swarm-dashboard {
                    padding: 1.5rem;
                    max-width: 1400px;
                    margin: 0 auto;
                    background: var(--swarm-bg);
                }

                .swarm-dashboard h1 {
                    font-size: 1.875rem;
                    font-weight: 600;
                    letter-spacing: -0.025em;
                    margin-bottom: 1.5rem;
                    color: var(--swarm-text);
                }

                .swarm-dashboard h3 {
                    font-size: 1rem;
                    font-weight: 600;
                    margin: 1.5rem 0 0.75rem 0;
                    color: var(--swarm-text);
                }

                /* Card */
                .swarm-card {
                    background: var(--swarm-card-bg);
                    border: 1px solid var(--swarm-border);
                    border-radius: var(--radius);
                    box-shadow: var(--shadow-sm);
                    padding: 1.5rem;
                    margin-bottom: 1.5rem;
                }

                .swarm-card-header {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    margin-bottom: 1.25rem;
                }

                .swarm-card-header span {
                    display: flex;
                    align-items: center;
                    gap: 0.75rem;
                    font-size: 1.125rem;
                    font-weight: 600;
                    color: var(--swarm-text);
                }

                /* Stats Grid */
                .swarm-stats {
                    display: grid;
                    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
                    gap: 1rem;
                }

                .swarm-stat {
                    background: var(--swarm-input-bg);
                    border: 1px solid var(--swarm-border);
                    border-radius: calc(var(--radius) - 2px);
                    padding: 1rem;
                    text-align: center;
                    transition: border-color 0.15s ease;
                }

                .swarm-stat:hover {
                    border-color: var(--swarm-text-secondary);
                }

                .swarm-stat-value {
                    font-size: 1.5rem;
                    font-weight: 700;
                    letter-spacing: -0.025em;
                    color: var(--swarm-text);
                    line-height: 1.2;
                }

                .swarm-stat-label {
                    font-size: 0.75rem;
                    font-weight: 500;
                    color: var(--swarm-text-secondary);
                    margin-top: 0.25rem;
                    text-transform: uppercase;
                    letter-spacing: 0.05em;
                }

                /* Table */
                .swarm-table {
                    width: 100%;
                    border-collapse: collapse;
                    font-size: 0.875rem;
                }

                .swarm-table thead {
                    border-bottom: 1px solid var(--swarm-border);
                }

                .swarm-table th {
                    padding: 0.75rem 1rem;
                    text-align: left;
                    font-weight: 500;
                    color: var(--swarm-text-secondary);
                    background: transparent;
                }

                .swarm-table td {
                    padding: 0.75rem 1rem;
                    border-bottom: 1px solid var(--swarm-border);
                    color: var(--swarm-text);
                }

                .swarm-table tbody tr {
                    transition: background-color 0.15s ease;
                }

                .swarm-table tbody tr:hover {
                    background-color: var(--swarm-hover-bg);
                }

                .swarm-table tbody tr:last-child td {
                    border-bottom: none;
                }

                /* Badges - shadcn style with dark theme support */
                .badge {
                    display: inline-flex;
                    align-items: center;
                    padding: 0.125rem 0.625rem;
                    border-radius: 9999px;
                    font-size: 0.75rem;
                    font-weight: 500;
                    line-height: 1.25rem;
                    transition: background-color 0.15s ease;
                }

                .badge-success {
                    background: hsl(142 76% 36%);
                    color: hsl(142 76% 96%);
                    border: 1px solid hsl(142 76% 46%);
                }

                .badge-warning {
                    background: hsl(32 95% 44%);
                    color: hsl(48 96% 98%);
                    border: 1px solid hsl(32 95% 54%);
                }

                .badge-danger {
                    background: hsl(0 84% 48%);
                    color: hsl(0 84% 98%);
                    border: 1px solid hsl(0 84% 58%);
                }

                .badge-secondary {
                    background: var(--swarm-input-bg);
                    color: var(--swarm-text-secondary);
                    border: 1px solid var(--swarm-border);
                }

                .badge-info {
                    background: hsl(199 89% 40%);
                    color: hsl(199 89% 98%);
                    border: 1px solid hsl(199 89% 50%);
                }

                /* Buttons - shadcn style */
                .btn-sm {
                    display: inline-flex;
                    align-items: center;
                    justify-content: center;
                    padding: 0.375rem 0.75rem;
                    font-size: 0.875rem;
                    font-weight: 500;
                    border-radius: calc(var(--radius) - 2px);
                    border: none;
                    cursor: pointer;
                    transition: all 0.15s ease;
                    outline: none;
                }

                .btn-sm:focus-visible {
                    outline: 2px solid var(--focus-ring-color, hsl(215 100% 50%));
                    outline-offset: 2px;
                }

                .btn-refresh {
                    background: var(--swarm-text);
                    color: var(--swarm-bg);
                }

                .btn-refresh:hover {
                    opacity: 0.9;
                }

                .btn-danger {
                    background: hsl(0 84% 60%);
                    color: white;
                }

                .btn-danger:hover {
                    background: hsl(0 84% 50%);
                }

                /* Empty state */
                .no-data {
                    text-align: center;
                    padding: 3rem 1rem;
                    color: var(--swarm-text-secondary);
                }

                .no-data p {
                    margin: 0.5rem 0;
                }

                .no-data a {
                    color: hsl(215 100% 60%);
                    text-decoration: none;
                    font-weight: 500;
                }

                .no-data a:hover {
                    text-decoration: underline;
                }

                /* Error message */
                .error-message {
                    background: hsl(0 84% 25%);
                    color: hsl(0 84% 95%);
                    border: 1px solid hsl(0 84% 35%);
                    border-radius: calc(var(--radius) - 2px);
                    padding: 0.75rem 1rem;
                    margin-bottom: 1rem;
                    font-size: 0.875rem;
                }

                /* Service error text */
                .swarm-table small {
                    color: hsl(0 84% 60%);
                    font-size: 0.75rem;
                }

                /* Responsive adjustments */
                @media (max-width: 768px) {
                    .swarm-dashboard {
                        padding: 1rem;
                    }

                    .swarm-stats {
                        grid-template-columns: repeat(2, 1fr);
                    }

                    .swarm-table {
                        font-size: 0.8125rem;
                    }

                    .swarm-table th,
                    .swarm-table td {
                        padding: 0.5rem 0.75rem;
                    }
                }
            </style>

            <div class="swarm-dashboard">
                <h1>Swarm Agents Dashboard</h1>

                <j:choose>
                    <j:when test="${empty(it.swarmClouds)}">
                        <div class="swarm-card">
                            <div class="no-data">
                                <p>No Docker Swarm clouds configured.</p>
                                <p><a href="${rootURL}/manage/cloud/">Configure a Swarm cloud</a></p>
                            </div>
                        </div>
                    </j:when>
                    <j:otherwise>
                        <j:forEach var="cloud" items="${it.swarmClouds}">
                            <j:set var="status" value="${it.getClusterStatus(cloud.name)}"/>

                            <div class="swarm-card">
                                <div class="swarm-card-header">
                                    <span>
                                        <j:choose>
                                            <j:when test="${status.healthy}">
                                                <span class="badge badge-success">Healthy</span>
                                            </j:when>
                                            <j:otherwise>
                                                <span class="badge badge-danger">Error</span>
                                            </j:otherwise>
                                        </j:choose>
                                        <j:out value="${cloud.name}"/>
                                    </span>
                                    <button class="btn-sm btn-refresh js-refresh-cloud"
                                            data-cloud-name="${h.xmlEscape(cloud.name)}">
                                        Refresh
                                    </button>
                                </div>

                                <j:if test="${!status.healthy}">
                                    <div class="error-message">
                                        <j:out value="${status.errorMessage}"/>
                                    </div>
                                </j:if>

                                <j:if test="${status.healthy}">
                                    <div class="swarm-stats">
                                        <div class="swarm-stat">
                                            <div class="swarm-stat-value">${status.readyNodes}/${status.totalNodes}</div>
                                            <div class="swarm-stat-label">Nodes Ready</div>
                                        </div>
                                        <div class="swarm-stat">
                                            <div class="swarm-stat-value">${status.currentAgents}/${status.maxAgents}</div>
                                            <div class="swarm-stat-label">Agents</div>
                                        </div>
                                        <div class="swarm-stat">
                                            <div class="swarm-stat-value">${status.runningTasks}</div>
                                            <div class="swarm-stat-label">Running</div>
                                        </div>
                                        <div class="swarm-stat">
                                            <div class="swarm-stat-value">${status.pendingTasks}</div>
                                            <div class="swarm-stat-label">Pending</div>
                                        </div>
                                        <div class="swarm-stat">
                                            <div class="swarm-stat-value">${status.failedTasks}</div>
                                            <div class="swarm-stat-label">Failed</div>
                                        </div>
                                        <div class="swarm-stat">
                                            <j:choose>
                                                <j:when test="${status.usedMemory > 0 || status.runningTasks == 0}">
                                                    <div class="swarm-stat-value">${status.formattedUsedMemory} / ${status.formattedMemory}</div>
                                                    <div class="swarm-stat-label">Memory (${String.format("%.1f", status.memoryUsagePercent)}%)</div>
                                                </j:when>
                                                <j:otherwise>
                                                    <div class="swarm-stat-value">— / ${status.formattedMemory}</div>
                                                    <div class="swarm-stat-label">Memory (N/A)</div>
                                                </j:otherwise>
                                            </j:choose>
                                        </div>
                                        <div class="swarm-stat">
                                            <j:choose>
                                                <j:when test="${status.usedCpu > 0 || status.runningTasks == 0}">
                                                    <div class="swarm-stat-value">${status.formattedUsedCpu} / ${status.formattedTotalCpu}</div>
                                                    <div class="swarm-stat-label">CPU Cores (${String.format("%.1f", status.cpuUsagePercent)}%)</div>
                                                </j:when>
                                                <j:otherwise>
                                                    <div class="swarm-stat-value">— / ${status.formattedTotalCpu}</div>
                                                    <div class="swarm-stat-label">CPU Cores (N/A)</div>
                                                </j:otherwise>
                                            </j:choose>
                                        </div>
                                    </div>

                                    <h3>Nodes</h3>
                                    <table class="swarm-table">
                                        <thead>
                                            <tr>
                                                <th>Hostname</th>
                                                <th>State</th>
                                                <th>Role</th>
                                                <th>Memory</th>
                                                <th>CPU</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <j:forEach var="node" items="${status.nodes}">
                                                <tr>
                                                    <td><j:out value="${node.hostname}"/></td>
                                                    <td>
                                                        <span class="badge badge-${node.stateClass}"><j:out value="${node.state}"/></span>
                                                    </td>
                                                    <td><j:out value="${node.role}"/></td>
                                                    <td>${node.formattedMemory}</td>
                                                    <td>${node.cpuCores} cores</td>
                                                </tr>
                                            </j:forEach>
                                        </tbody>
                                    </table>

                                    <h3>Services</h3>
                                    <j:choose>
                                        <j:when test="${empty(status.services)}">
                                            <p class="no-data">No active services</p>
                                        </j:when>
                                        <j:otherwise>
                                            <table class="swarm-table">
                                                <thead>
                                                    <tr>
                                                        <th>Name</th>
                                                        <th>Template</th>
                                                        <th>State</th>
                                                        <th>Uptime</th>
                                                        <th>Actions</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <j:forEach var="svc" items="${status.services}">
                                                        <tr>
                                                            <td><j:out value="${svc.name}"/></td>
                                                            <td><j:out value="${svc.templateName}"/></td>
                                                            <td>
                                                                <span class="badge badge-${svc.stateClass}"><j:out value="${svc.state}"/></span>
                                                                <j:if test="${svc.error != null}">
                                                                    <br/><small><j:out value="${svc.error}"/></small>
                                                                </j:if>
                                                            </td>
                                                            <td>${svc.uptime}</td>
                                                            <td>
                                                                <button class="btn-sm btn-danger js-remove-service"
                                                                        data-cloud-name="${h.xmlEscape(cloud.name)}"
                                                                        data-service-id="${h.xmlEscape(svc.id)}">
                                                                    Remove
                                                                </button>
                                                            </td>
                                                        </tr>
                                                    </j:forEach>
                                                </tbody>
                                            </table>
                                        </j:otherwise>
                                    </j:choose>
                                </j:if>
                            </div>
                        </j:forEach>
                    </j:otherwise>
                </j:choose>
            </div>

            <script>
                (function() {
                    'use strict';

                    var rootUrl = '${rootURL}';

                    function refreshCloud(cloudName) {
                        fetch(rootUrl + '/swarm-dashboard/refresh?cloud=' + encodeURIComponent(cloudName), {
                            method: 'POST',
                            headers: crumb.wrap({})
                        }).then(function() {
                            location.reload();
                        }).catch(function(err) {
                            alert('Failed to refresh: ' + err);
                        });
                    }

                    function removeService(cloudName, serviceId) {
                        if (!confirm('Are you sure you want to remove this service?')) return;

                        fetch(rootUrl + '/swarm-dashboard/removeService?cloud=' + encodeURIComponent(cloudName) +
                              '&amp;serviceId=' + encodeURIComponent(serviceId), {
                            method: 'POST',
                            headers: crumb.wrap({})
                        }).then(function() {
                            location.reload();
                        }).catch(function(err) {
                            alert('Failed to remove service: ' + err);
                        });
                    }

                    // Event delegation for refresh buttons
                    document.addEventListener('click', function(e) {
                        if (e.target.classList.contains('js-refresh-cloud')) {
                            var cloudName = e.target.getAttribute('data-cloud-name');
                            if (cloudName) refreshCloud(cloudName);
                        }
                        if (e.target.classList.contains('js-remove-service')) {
                            var cloudName = e.target.getAttribute('data-cloud-name');
                            var serviceId = e.target.getAttribute('data-service-id');
                            if (cloudName &amp;&amp; serviceId) removeService(cloudName, serviceId);
                        }
                    });

                    // Auto-refresh every 30 seconds
                    setTimeout(function() { location.reload(); }, 30000);
                })();
            </script>
        </l:main-panel>
    </l:layout>
</j:jelly>
